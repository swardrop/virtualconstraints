\subsection{Optimisation of a single constraint}
\subsubsection{Motivation of need for optimisation}
Note on intractability of gridding approaches

The first challenge in producing a library of virtual constraints is to produce a method by which a single constraint may be optimised -- the optimality of a planned trajectory cannot exceed the optimality of the primitives which compose it. The definition of optimality in the case of a bipedal robot is not clear; {\color{red}<insert literature references to competing definitions>}.

The definition of optimality chosen for the purposes of producing the virtual constraint library is as follows:

\emph{The optimal constraint for a given start and end configuration and kinetic energy gain or loss is the one which requires the minimum RMS torque value to maintain.}

Using this definition, we may further motivate the need for optimisation of the virtual constraints by way of example. Consider Figure \ref{fig:manualgen}; the constraint has been chosen based upon reasoning that it appears to produce a net-gain kinetic energy in a fairly smooth motion. However, the torque required to maintain this motion is clearly wasteful and nonmonotonic. {\color{red} Maybe try to give some good justification here.}

\begin{figure}
	\centering
	\includegraphics[width=0.9\linewidth]{4VirtConstLib/manualgen.png}
	\caption{Torque curve for manually generated constraint}
	\label{fig:manualgen}
\end{figure}

\subsubsection{Validity of convex optimisation approach}
Surfaces which confirm quasi-convexity.

\subsubsection{Optimisation method}
Unfortunately, the torque required to maintain a constraint varies with initial velocity. Since the virtual constraint library is prepared off-line, the initial velocity is unknown. The constraint is therefore optimised over a nominal trajectory. That is, each virtual constraint is only perfectly optimised for a particular initial velocity. {\color{red} Justify this, and go into depth about the choice of initial velocity? There's no reason that this should be the same per constraint. The nominal trajectory is probably different for each constraint.}

The nominal initial velocity for a particular constraint was chosen to be that which achieves periodic walking based upon the constraint. That is, the output of the impact map $\dot{\theta}^+$ is equal to the initial velocity $\dot{\theta}_0$. This is calculable in closed-form: The following relations are trivially obtained from the partial closed form solution and the impact map (Equations \ref{eqn:??} and \ref{eqn:??}):
\begin{subequations}
\begin{align}
	\left(\dot{\theta}^-\right)^2 &= \Gamma(\theta^-)\dot{\theta}_0^2 + \Psi(\theta^-) \\
	\dot{\theta}^+ &= \Delta_{\dot{\theta}}\dot{\theta}^- \\
	\Delta_{\dot{\theta}} &:= cR\Delta(\Phi(\theta^-))\Phi'(\theta^-)
\end{align}
\end{subequations}
Equating $\dot{\theta}^+$ and $\dot{\theta}_0$, we obtain (periodic velocity)
\begin{equation}
	\dot{\theta}_{0,p}^2 = \frac{\Psi(\theta^-)}{\Delta_{\dot{\theta}}^{-2} - \Gamma(\theta^-)}
\end{equation}
Achieving fixed post-impact velocity:
\begin{equation}
	\dot{\theta}_{0,f}^2 = \frac{\Delta_{\dot{\theta}}^{-2}\dot{\theta}_f^2 - \Psi(\theta^-)} {\Gamma(\theta^-)}
\end{equation}
Equating $\dot{\theta}^+$ with $\lambda\dot{\theta}_{0,c}$ (Achieving fixed ratio $\lambda$ over minimum velocity to complete footstep):
\begin{equation}
	\dot{\theta}_{0,\lambda}^2 = \frac{-\frac{\lambda^2 \Psi(\theta_c)}{\Delta_{\dot{\theta}}^2 \Gamma(\theta_c)} - \Psi(\theta^-)} {\Gamma(\theta^-)}
\end{equation}
{\color{blue} Why do this instead of just using $\dot{\theta}_0 = \lambda\dot{\theta}_{0,c}$? I think it's better because it takes into account the impacts and therefore more realistically defines the required velocity for the constraint. I need to think this through a bit more. Maybe in this section go through all of the logical alternatives to setting up the nominal velocity and justify which is best.}

{\color{red} Also need to include constraints - friction cone and invariance. Note choice of zero slope to allow for velocity invariance to be satisfied and friction cone being dependent only on the configuration, since the forces themselves are dependent on the velocity, but the ratio is fixed by the constraint; $F_2$ is linear in $\dot{q}$. Also, perhaps discuss using time basis/using theta basis; theta basis may be skewed since it is not linear in time, so integral of torque as a function of theta gives a different result to integral of torque as a function of time. We can derive time-based torque at the cost of additional computation}


\subsection{Library generation}
Optimising a particular constraint for minimum torque is valuable for the achievement of efficient periodic walking on flat ground, however coverage over the configuration space of the robot is required for walking over uneven terrain. In addition, a viable solution must include a means of velocity control. Therefore, we require coverage of the configuration space with optimised constraints which achieve additions and subtractions of kinetic energy. Constraints which allow for an increase in kinetic energy are required to facilitate steps against the gravitational potential field, and decreases in kinetic energy may be required to keep the motor output within torque limits, to limit excessive wear on the robot, and to bring the walker to a stop once it has completed its task.